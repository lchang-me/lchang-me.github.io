{{- if not ($.Page.Scratch.Get "embed-pdf-count") -}}
<script type="text/javascript" src= '/js/pdf-js/build/pdf.js'></script>

<style>
  .embed-pdf-container {
    position: relative;
    width: 100%;
    height: auto;
    min-height: 20vh; /* 占位，防止页面抖动 */
    margin-bottom: 20px;
    border: 1px solid #e0e0e0;
  }
  
  .pdf-canvas {
    direction: ltr;
    width: 100%;
    height: auto;
    display: none; /* 默认隐藏，渲染完显示 */
  }
  
  .pdf-loadingWrapper {
    display: flex;
    justify-content: center;
    align-items: center;
    width: 100%;
    height: 300px;
    background: #f9f9f9;
    flex-direction: column;
    color: #666;
  }
  
  .pdf-loading {
    display: inline-block;
    width: 40px;
    height: 40px;
    border: 3px solid #d2d0d0;
    border-radius: 50%;
    border-top-color: #333;
    animation: spin 1s ease-in-out infinite;
    -webkit-animation: spin 1s ease-in-out infinite;
    margin-bottom: 10px;
  }

  /* 翻页器样式 */
  .pdf-paginator {
    text-align: center;
    margin-top: 10px;
    font-size: 0.9rem;
    color: #333;
  }
  .pdf-paginator button {
    background: #fff;
    border: 1px solid #ccc;
    padding: 5px 15px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.85rem;
  }
  .pdf-paginator button:hover {
    background: #f0f0f0;
  }
  
  @keyframes spin {
    to { -webkit-transform: rotate(360deg); }
  }
</style>
{{- end -}}

{{- $.Page.Scratch.Add "embed-pdf-count" 1 -}}
{{ $id := substr (.Get "url" | md5) 0 8 }}

<div class="embed-pdf-container" id="embed-pdf-container-{{ $id }}">
    
    <div class="pdf-loadingWrapper" id="pdf-loadingWrapper-{{ $id }}">
        <div class="pdf-loading"></div>
        <span style="font-size: 0.8rem;">Loading PDF...</span>
    </div>

    <canvas class="pdf-canvas" id="pdf-canvas-{{ $id }}"></canvas>
</div>

<div class="pdf-paginator" id="pdf-paginator-{{ $id }}" style="display:none;">
    <button id="pdf-prev-{{ $id }}">Previous</button>
    <span style="margin: 0 10px;">
      <span class="pdf-pagenum" id="pdf-pagenum-{{ $id }}">1</span> / <span class="pdf-pagecount" id="pdf-pagecount-{{ $id }}">--</span>
    </span>
    <button id="pdf-next-{{ $id }}">Next</button>
</div>

<script type="text/javascript">
(function() {
    var url = '{{ .Get "url" }}';
    var pdfId = "{{ $id }}";
    var container = document.getElementById('embed-pdf-container-' + pdfId);
    var canvas = document.getElementById('pdf-canvas-' + pdfId);
    var ctx = canvas.getContext('2d');
    var loadingWrapper = document.getElementById('pdf-loadingWrapper-' + pdfId);
    var paginator = document.getElementById("pdf-paginator-" + pdfId);
    var pageNumSpan = document.getElementById('pdf-pagenum-' + pdfId);
    var pageCountSpan = document.getElementById('pdf-pagecount-' + pdfId);
    
    var pdfDoc = null;
    var pageNum = parseInt("{{ .Get "renderPageNum" }}") || 1;
    var pageRendering = false;
    var pageNumPending = null;
    
    // 保持优化：缩放比例 Scale = 1.5 (平衡清晰度与速度)
    var scale = 1.5; 

    var pdfjsLib = window['pdfjs-dist/build/pdf'];
    if (pdfjsLib.GlobalWorkerOptions.workerSrc == '')
      pdfjsLib.GlobalWorkerOptions.workerSrc = "{{.Site.BaseURL}}" + 'js/pdf-js/build/pdf.worker.js';

    function renderPage(num) {
      pageRendering = true;
      
      pdfDoc.getPage(num).then(function(page) {
        var viewport = page.getViewport({scale: scale});
        canvas.height = viewport.height;
        canvas.width = viewport.width;

        var renderContext = {
          canvasContext: ctx,
          viewport: viewport
        };
        var renderTask = page.render(renderContext);

        renderTask.promise.then(function() {
          pageRendering = false;
          loadingWrapper.style.display = 'none';
          canvas.style.display = 'block';
          
          if (pageNumPending !== null) {
            renderPage(pageNumPending);
            pageNumPending = null;
          }
        });
      });
      pageNumSpan.textContent = num;
    }

    function queueRenderPage(num) {
      if (pageRendering) {
        pageNumPending = num;
      } else {
        renderPage(num);
      }
    }

    function onPrevPage() {
      if (pageNum <= 1) return;
      pageNum--;
      queueRenderPage(pageNum);
    }

    function onNextPage() {
      if (pageNum >= pdfDoc.numPages) return;
      pageNum++;
      queueRenderPage(pageNum);
    }

    document.getElementById('pdf-prev-' + pdfId).addEventListener('click', onPrevPage);
    document.getElementById('pdf-next-' + pdfId).addEventListener('click', onNextPage);

    // 保持优化：懒加载逻辑
    function initPDF() {
        console.log("Start loading PDF: " + url);
        pdfjsLib.getDocument(url).promise.then(function(pdfDoc_) {
            pdfDoc = pdfDoc_;
            pageCountSpan.textContent = pdfDoc.numPages;
            
            if (pdfDoc.numPages > 1) {
                paginator.style.display = 'block';
            }

            if(pageNum > pdfDoc.numPages) pageNum = pdfDoc.numPages;
            renderPage(pageNum);
        }).catch(function(error) {
            console.error('Error loading PDF:', error);
            loadingWrapper.innerHTML = '<span style="color:red">Error loading PDF.</span>';
        });
    }

    if ('IntersectionObserver' in window) {
        var observer = new IntersectionObserver(function(entries) {
            entries.forEach(function(entry) {
                if (entry.isIntersecting) {
                    initPDF();
                    observer.unobserve(container);
                }
            });
        }, { rootMargin: "200px" }); 
        
        observer.observe(container);
    } else {
        initPDF();
    }

})();
</script>
