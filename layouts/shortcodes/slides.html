{{/* Shortcode: slides (防抖动稳健版) */}}
{{ $folder := .Get "folder" | default "slides" }}
{{ $matchPattern := printf "%s/*" $folder }}
{{ $resources := .Page.Resources.Match $matchPattern }}
{{ $images := sort $resources "Name" "asc" }}
{{ $uniqueID := substr (md5 .Position) 0 8 }}

{{ if not $images }}
<div style="color: red; border: 1px solid red; padding: 10px;">
    Error: 文件夹 <code>{{ $folder }}</code> 为空或路径错误。
</div>
{{ else }}

<div class="ppt-viewer" id="ppt-viewer-{{ $uniqueID }}">

    <div class="ppt-screen">
        {{ range $index, $img := $images }}
        <div class="ppt-slide {{ if eq $index 0 }}active{{ end }}" data-index="{{ $index }}">
            <img src="{{ $img.RelPermalink }}" alt="{{ $img.Name }}" loading="lazy">
        </div>
        {{ end }}
    </div>

    <div class="ppt-controls">
        <button type="button" class="btn-prev">← Prev</button>

        <span class="ppt-counter">
            <span class="current-page">1</span> / <span class="total-pages">{{ len $images }}</span>
        </span>

        <button type="button" class="btn-next">Next →</button>
    </div>

</div>

<script>
    (function () {
        const viewerId = "ppt-viewer-{{ $uniqueID }}";
        const container = document.getElementById(viewerId);
        if (!container) return;

        const slides = container.querySelectorAll('.ppt-slide');
        const btnPrev = container.querySelector('.btn-prev');
        const btnNext = container.querySelector('.btn-next');
        const currentSpan = container.querySelector('.current-page');

        let currentIndex = 0;
        const totalSlides = slides.length;

        function updateSlide(newIndex) {
            if (newIndex < 0 || newIndex >= totalSlides) return;

            // 移除旧的 active
            slides[currentIndex].classList.remove('active');

            // 更新索引
            currentIndex = newIndex;

            // 添加新的 active
            slides[currentIndex].classList.add('active');

            // 更新页码
            currentSpan.textContent = currentIndex + 1;

            // 按钮状态
            btnPrev.disabled = (currentIndex === 0);
            btnNext.disabled = (currentIndex === totalSlides - 1);

            // 关键：点击后移除按钮焦点，防止浏览器为了对齐焦点而滚动
            btnPrev.blur();
            btnNext.blur();
        }

        updateSlide(0);

        // 绑定事件，使用 stopPropagation 防止冒泡
        btnPrev.addEventListener('click', function (e) {
            e.preventDefault();
            e.stopPropagation();
            updateSlide(currentIndex - 1);
        });

        btnNext.addEventListener('click', function (e) {
            e.preventDefault();
            e.stopPropagation();
            updateSlide(currentIndex + 1);
        });
    })();
</script>


{{ end }}